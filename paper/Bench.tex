\section{Evaluating the library \label{bench}}

A way of applying  the two-level approach for proving primality has been presented in~\cite{GreTheWer}.
It is based on the notion of prime certificate and more 
precisely of {\it Pocklington certificate}.
A prime certificate is an object that witnesses the primality of a number.
The Pocklington certificates we have been using are justified by the following
theorem given in~\cite{lehmer}:
\begin{theorem}\label{lehmer}
Given a number $n$, a witness $a$ and some pairs of natural numbers 
$(p_1,\alpha_1),\dots,(p_k,\alpha_k)$
 where all the $p_i$ are prime numbers,
 let
 \begin{itemize}
\item[]$F_1 = p_1^{\alpha_1}\dots p_k^{\alpha_k}$
\item[]$R_1 = (n - 1) / F_1$
\item[]$ s = R_1 / (2F_1)$
\item[] $r = R_1 \mod\ (2F_1)$
 \end{itemize}
 it is sufficient for $n$ to be prime that the following conditions hold:
\begin{eqnarray}
F_1 \,\,\hbox{is even},\,\,
R_1 \,\, \hbox{is odd}, \,\,\hbox{and}\,\,
F_1R_1  &=&  n -1\\
(F_1 + 1) (2F_1^2 + (r - 1) F_1 + 1) & >& n\\
a^{n-1} &=& 1 (\mod\ n)\\
\forall i\in\{1,\dots,k\}~\gcd(a^{\frac{n-1}{p_i}}-1,n)&=&1\\
r^2 - 8 s\,\,\mbox{is not a square}\,\,\hbox{or}\,\,s &=& 0
\end{eqnarray}
\end{theorem}
For a prime number $n$, the list 
$[a, p_1, \alpha_1, p_2, \alpha_2, \dots, p_k, \alpha_k]$
represents its Pocklington certificate.
Even if generating a certificate for a given $n$ can be cpu-intensive, 
verifying conditions (1)-(5) is an order of magnitude simpler (computing $a^m$ requires
a maximum of $2\textit{log}_2\, m$ multiplications). In fact, only
the verification of conditions (1)-(5) is crucial for asserting primality. 
This requires safe computation and is done inside {\sc Coq}.
The generation of the certificate is delegated to an external tool.
This is a direct application of the skeptic approach described 
in~\cite{BarBar,HarThe}. Note that this method of certifying prime numbers
is effective only if the prime number $n$ is such that  $n-1$ can be easily
partially factorised.
                 
With respect to the usual approach for the same 
problem~\cite{Caprotti_Oostdijk:01pockjsc}, the two-level
approach gives a significant improvement in terms of size of the
proof object and in terms of time.  
Figure~\ref{fig:TimeComp} illustrates this on some examples 
($P_{150}$ is a random prime number with 150 digits and the millennium prime is
a prime number with 2000 digits discovered by John B. Cosgrave).
However, due to the limitations of the linear representation of numbers in {\sc Coq},
even with the two-level approach, we were not capable of certifying large prime numbers 
(> 1000 digits) as illustrated by the millennium prime.
The same occurred when applying the Lucas-Lehmer test
for proving the primality of Mersenne numbers, 
i.e. numbers that can be written as $2 ^ p -1$.
\begin{theorem}\label{lucas}
Let ($S_n$) be recursively defined by $S_0= 4$ and $S_{n+1} = S_n^2 - 2$.
For $p > 2$, $2^p-1$ is prime if and only if $(2^p -1) | S_{p-2}$.
\end{theorem}
The largest Mersenne number we could certify was $2^{4423} - 1$ that has 1332 digits. 

The idea is then to use our new library based on a tree-like representation of numbers.
The complete library with the corresponding contribution for prime numbers 
is available at \url{http://gforge.inria.fr/projects/coqprime/}. 
It consists of 9000 lines of hand-written definitions and proofs. 
The automatically generated {\tt word8} arithmetic is much bigger,
95 Mb: 41 Mb are used to define functions and 54 Mb for the proofs. 
This is the largest ever contribution that has been verified by {\sc Coq}. 
With this new library, we have been capable of proving that the Mersenne number
$2^{44497} - 1$ was prime using {\sc Coq} with the Lucas-Lehmer test. 
As far as we know, it is the largest prime number  that has been certified 
by a theorem prover.

The certification with our library is faster even for  small numbers. 
This is illustrated in Figure~\ref{fig:TimeCompW} and the fifth and sixth  
columns of Figure~\ref{fig:Mersenne}. There is a maximum speed-up of 70. 
These benchmarks have been run on a Pentium 4 with 1 Gigabytes of RAM.

Comparing {\tt word8} with the 31-bit {\sc Ocaml} integer {\tt w31} shows 
all the benefit we could get from having machine words in {\sc Coq}. 
There is a maximum speed-up of 95 with respect to {\tt word8}. This
means a speed-up of 6650 with respect to the standard {\sc Coq} library.

The 64-bit {\sc Ocaml} integer {\tt w64} is a simulated arithmetic 
(our processor has only 32 bits).
This is why there is not such a gap between {\tt w31} and {\tt w64}. 
{\sc Big\_int}~\cite{bignum} is the  standard exact library for {\sc Ocaml}. 
It has a purely functional interface but 
is written in C. The comparison is not bad. For the last Mersenne, {\tt w64}
is only 4.6 times slower than {\sc Big\_int}. 
It is also very interesting that this gap is getting smaller as numbers get larger. 
On individual functions, random tests on addition give a ratio of 4 and on multiplication a ratio of 10.

We are still far away from getting the performance of the {\sc gmp}~\cite{GMP}
library. This library is written in C and uses in-place computation instead. 
This minimises considerably the number of memory allocations.
Unfortunately, in-place computation is not compatible with 
the logic of {\sc Coq}.

\begin{figure}
\begin{center}
\begin{tabular}{|l|r|r|r|r|r|r|}
\cline{3-6}
\multicolumn{2}{c}{} & \multicolumn{2}{|c|}{size} &
                                               \multicolumn{2}{c|}{time} \\
\hline
~prime     ~     & \multicolumn{1}{c|}{~digits~ } & ~standard~  &
  \multicolumn{1}{c|}{ ~two-level~ } &
  \multicolumn{1}{c|}{ ~standard~ } &
  \multicolumn{1}{c|}{ ~two-level~ } \\
\hline
~1234567891       ~   & 10~ &  94K~ &  ~0.453K~ & 3.98s~  & 0.50s~  \\
~74747474747474747~   & 17~ & 145K~ &  0.502K~ &   9.87s~ & 0.56s~ \\
~1111111111111111111~ & 19~ & 223K~ &  0.664K~ & 17.41s~  & 0.66s~   \\
~$(2^{148}+1)/17$ ~   & 44~ & 1.2M~ & 0.798K~ & ~350.63s~  & 2.77s~   \\
~$P_{150}$   ~        &150~ &  \_~  & 1.902K~   &  \_~   & 75.62s~  \\
~$\textit{millennium prime}$~   &2000 & \_~   & \_~      & \_~    & \_~ \\
\hline
\end{tabular}
\end{center}
\caption{Some verifications of certificates with the standard and two-level approaches}
\label{fig:TimeComp}
\end{figure} 
\begin{figure}
\begin{center}
\begin{tabular}{|l|r| r|r|}
\hline
 & ~digits~ & ~positive~ & ~word8~ \\
\hline
~1234567891       ~  & 10~  & 0.50s~  & 0.10s~  \\
~74747474747474747~  & 17~ & 0.56s~  & 0.12s~  \\
~1111111111111111111~ & 19~ & 0.66s~ & 0.20s~  \\
~$(2^{148}+1)/17$ ~   & 44~ & 2.77s~  & 0.36s~  \\
~$P_{150}$   ~       & 150~ & 75.62s~  & 8.44s~  \\
~$\textit{millennium prime}$~   &2000 & \_~   & 5320.05s~ \\
\hline
\end{tabular}
\end{center}
\caption{Some verifications of certificates with the standard and our {\sc Coq} arithmetics}
\label{fig:TimeCompW}
\end{figure} 
\begin{figure}
\begin{center}
\begin{tabular}{|r|r|r|r|r|r|r|r|r |}
\hline
\# & n & digits & year &  positive & word8 & w31 & w64 & Big\_int\\
\hline
12 &  127 &  39 & 1876 &  0.73s & 0.04s & 0.01s & 0.s & 0.s \\
13 &  521 & 157 & 1952 &  53.00s & 1.85s & 0.02s & 0.02s &  0.s\\
14 &  607 & 183 & 1952 &  84.00s & 2.78s & 0.03s & 0.03s &  0.s\\
15 & 1279 & 386 & 1952 &  827.00s & 20.21s& 0.25s & 0.16s &  0.02s\\
16 & 2203 & 664 & 1952 &  4421.00s & 89.1s & 1.1s & 0.8s &  0.08s\\
17 & 2281 & 687 & 1952 &  4964.00s & 97.59s & 1.21s & 0.82s &  0.09s\\
18 & 3217 & 969 & 1957 &  14680.00s & 237.65s & 2.85s & 2.14s &  0.22s\\
19 & 4253 & 1281 & 1961 &35198.00s & 494.09s& 6.4s & 4.58s &  0.6s\\
20 & 4423 & 1332 & 1961 &  39766.00s & 563.27s & 6.99s & 4.99s &  0.67s\\
21 & 9689 & 2917  & 1963 &   & 5304.08s & 56.1s & 39.98s &  5.89s\\	 
22 & 9941 & 2993  & 1963 &   & 5650.63s & 60.5s & 42.53s &  6.32s\\	 
23 & 11213 & 3376 & 1963 &    & 7607.00s & 80.56s & 57.47s &  11.25s\\ 
24 & 19937 & 6002  & 1971 &  & 34653.12s & 377.24s & 268.09s &  45.75s\\
25 & 21701 & 6533 & 1978 &  &43746.21s & 463.02s & 338.04s &  58.56s \\
26 & 23209 & 6987 & 1979  &  &51210.56s & 538.33s & 403.48s &  88.43s\\
27 & 44497 & 13395 & 1979  &  &282784.09s & 3282.23s & 2208.45s &  476.75s \\
\hline

\end{tabular}
\end{center}
\caption{Times to verify Mersenne numbers}
\label{fig:Mersenne}
\end{figure}
